{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <!-- Información del Afiliado -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Datos del Afiliado</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>Nombre:</strong> {{ tramite.afiliado.nombre }}
                </div>
                <div class="col-md-4">
                    <strong>Apellido:</strong> {{ tramite.afiliado.apellido }}
                </div>
                <div class="col-md-4">
                    <strong>Dirección:</strong> {{ tramite.afiliado.direccion }}
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>Número de Trámite:</strong> {{ tramite.numero_tramite }}
                </div>
                <div class="col-md-4">
                    <strong>Fecha:</strong> {{ tramite.fecha_creacion }}
                </div>
                <div class="col-md-4">
                    <strong>Usuario:</strong> {{ tramite.usuario.username }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <strong>Federación:</strong> {{ tramite.afiliado.federacion.nombre }}
                </div>
                <div class="col-md-4">
                    <strong>Fecha de validez:</strong> {{ tramite.fecha_validezI }} - {{ tramite.fecha_validezF }}
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalRuta">
            Añadir Ruta
        </button>
    </div>

    <!-- Formulario del Vehículo -->
    <form method="POST" action="#">
        {% csrf_token %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Formulario del Vehículo</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="placa" class="form-label">Placa</label>
                        <input type="text" value="{{ tramite.vehiculo.placa }}" class="form-control" required id="placa"
                            name="placa">
                    </div>
                    <div class="col-md-4">
                        <label for="tipo_transporte" class="form-label">Tipo de Transporte</label>
                        <select class="form-control" required id="tipo_transporte" name="tipo_transporte">
                            <option value="" disabled {% if not tramite.vehiculo.tipo_transporte %}selected{% endif %}>
                                Seleccione una opción</option>
                            <option value="Pasajeros" {% if tramite.vehiculo.tipo_transporte == "Pasajeros" %}selected{%endif %}>Pasajeros</option>
                            <option value="Carga" {% if tramite.vehiculo.tipo_transporte == "Carga" %}selected{% endif %}>
                                Carga</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="modelo" class="form-label">Modelo</label>
                        <input type="text" required class="form-control" id="modelo" name="modelo"
                            value="{{ tramite.vehiculo.modelo }}">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="marca" class="form-label">Marca</label>
                        <input type="text" value="{{ tramite.vehiculo.marca }}" required class="form-control" id="marca"
                            name="marca">
                    </div>
                    <div class="col-md-4">
                        <label for="chasis" class="form-label">Número de Chasis</label>
                        <input type="text" value="{{ tramite.vehiculo.chasis }}" required class="form-control"
                            id="chasis" name="chasis">
                    </div>
                    <div class="col-md-4">
                        <label for="tipo_servicio" class="form-label">Tipo de Servicio</label>
                        <input type="text" value="{{ tramite.vehiculo.tipo_vehiculo }}" required class="form-control"
                            id="tipo_servicio" name="tipo_servicio">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="capacidad" class="form-label">Capacidad</label>
                        <input type="number" value="{{ tramite.vehiculo.capacidad }}" required class="form-control"
                            id="capacidad" name="capacidad">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Ruta Seleccionada</label>
                        <input value="{{tramite.rutas.nombre}}" type="text" readonly class="form-control" id="ruta_nombre_mostrar" required>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#modalRuta1">
                            Listar Rutas Autorizadas
                        </button>
                    </div>
                    <input  value="{{tramite.rutas.id}}" type="hidden" id="ruta_id" name="ruta_id">

                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </div>
        </div>
    </form>
</div>
<!-- Modal: Añadir Ruta -->
<div class="modal fade" id="modalRuta" tabindex="-1" aria-labelledby="modalRutaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRutaLabel">Añadir Ruta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
          
            <form id="formRuta">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre de la Ruta</label>
                        <textarea class="form-control" id="nombre" name="nombre" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Ruta</button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Modal: Listar Rutas -->
<div class="modal fade" id="modalRuta1" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rutas Autorizadas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nombre</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="tabla_rutas_body">
                        <!-- Filas insertadas dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Crear ruta
    document.getElementById('formRuta').addEventListener('submit', function (e) {
        e.preventDefault();
        const nombre = document.getElementById('nombre').value;
        axios.post("{% url 'crearRuta' %}", {
            nombre: nombre
        }, {
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.data.estatus === 201) {
                    alert('Ruta guardada correctamente');
                    document.getElementById('formRuta').reset();
                    bootstrap.Modal.getInstance(document.getElementById('modalRuta')).hide();
                }
            })
            .catch(error => {
                console.error(error);
                alert('Hubo un error al guardar la ruta');
            });
    });


    document.getElementById('modalRuta1').addEventListener('show.bs.modal', function () {
        axios.get("{% url 'listarRuta' %}")
            .then(response => {
                const rutas = response.data;
                const tbody = document.getElementById('tabla_rutas_body');
                tbody.innerHTML = ''; // Limpiar

                rutas.forEach((ruta, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${ruta.nombre}</td>
                    <td><button class="btn btn-sm btn-success seleccionar-ruta" data-id="${ruta.id}" data-nombre="${ruta.nombre}">Seleccionar</button></td>
                `;
                    tbody.appendChild(row);
                });


                document.querySelectorAll('.seleccionar-ruta').forEach(btn => {
                    btn.addEventListener('click', function () {
                      
                        
                        const rutaId = this.getAttribute('data-id');
                        console.log(rutaId);
                        
                        const rutaNombre = this.getAttribute('data-nombre');
                        document.getElementById('ruta_id').value = rutaId;
                        document.getElementById('ruta_nombre_mostrar').value = rutaNombre;
                        bootstrap.Modal.getInstance(document.getElementById('modalRuta1')).hide();
                    });
                });
            })
            .catch(error => {
                console.error("Error al cargar las rutas:", error);
            });
    });
</script>
{% endblock %}